<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dropdown Menu with Multiple Selection</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <div class="relative inline-block text-left">
      <div>
        <button
          type="button"
          id=""
          class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >
          Options
          <svg
            class="-mr-1 ml-2 h-5 w-5"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 20 20"
            fill="currentColor"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M10 3a1 1 0 01.894.553l3 6a1 1 0 01-.737 1.447l-6 1.5a1 1 0 01-1.117-.992L6 8H4a1 1 0 110-2h2a1 1 0 01.894-.553L10 3zm0 11a1 1 0 01-.894-.553L6 7H4a1 1 0 010-2h2a1 1 0 01.894.553l3 6a1 1 0 01.737 1.447l-6 1.5a1 1 0 01-1.117-.992L4 12H2a1 1 0 010-2h2a1 1 0 01.894.553L10 15zm1-6a1 1 0 011.117.992l.992-2.981a1 1 0 01.737-1.447l6-1.5a1 1 0 01.737 1.447l-.992 2.981A1 1 0 0116 9H14a1 1 0 01-.894-.553L11 5zm6-1a1 1 0 01.894-.553L14 7h2a1 1 0 110 2h-2a1 1 0 01-.894-.553L11 5zm2 5a1 1 0 01.894.553L14 7H12a1 1 0 110-2h2a1 1 0 01.894.553L16 9zm2-1a1 1 0 01.894-.553L16 9h2a1 1 0 110 2h-2a1 1 0 01-.894-.553L14 7zm-2-3a1 1 0 01.894-.553L12 5H10a1 1 0 110-2h2a1 1 0 01.894.553L14 7zm0 8a1 1 0 01.894.553L12 17H10a1 1 0 110-2h2a1 1 0 01.894.553L14 17zm2-1a1 1 0 01.894.553L16 17h2a1 1 0 110 2h-2a1 1 0 01-.894-.553L14 15zm-2-1a1 1 0 01.894.553L12 15H10a1 1 0 110-2h2a1 1 0 01.894.553L14 15zm-2-5a1 1 0 01.894.553L12 9H10a1 1 0 110-2h2a1 1 0 01.894.553L14 9z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
      </div>
      <div
        id="dropdownMenu"
        class="origin-top-right right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden"
      >
        <div
          class="py-1"
          role="menu"
          aria-orientation="vertical"
          aria-labelledby="dropdownButton"
        >
          <!-- Options will be dynamically inserted here -->
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        const dropdownButton = $("#dropdownButton");
        const dropdownMenu = $("#dropdownMenu");

        dropdownButton.click(function () {
          dropdownMenu.toggleClass("hidden");
        });

        $(document).on("click", function (event) {
          if (
            !$(event.target).closest("#dropdownButton, #dropdownMenu").length
          ) {
            dropdownMenu.addClass("hidden");
          }
        });

        function loadDropdownOptions(idExchangeRate) {
          $.ajax({
            url: `http://localhost:8080/policy/detail?idExchangeRate=${idExchangeRate}`,
            method: "GET",
            success: function (response) {
              if (response.status === 200) {
                populateDropdown(
                  response.data.fullOption,
                  response.data.selectOption
                );
              } else {
                alert("Failed to fetch options");
              }
            },
            error: function () {
              alert("Error fetching options");
            },
          });
        }

        function populateDropdown(fullOptions, selectedOptions) {
          const dropdownContent = dropdownMenu.find(".py-1");
          dropdownContent.empty();

          fullOptions.forEach((option) => {
            const isChecked = selectedOptions.some(
              (selected) => selected.id === option.id
            );
            const optionElement = `
              <label class="flex items-center px-4 py-2 text-sm text-gray-700">
                <input type="checkbox" class="mr-2" name="options" value="${
                  option.id
                }" ${isChecked ? "checked" : ""} />
                ${option.name}
              </label>
            `;
            dropdownContent.append(optionElement);
          });

          dropdownContent.append(`
            <button
              id="applyButton"
              class="w-full px-4 py-2 bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700 focus:outline-none"
            >
              Apply
            </button>
          `);
        }

        $(document).on("click", "#bttn-detail", function () {
          const idExchangeRate = $(this).data("id");
          loadDropdownOptions(idExchangeRate);
        });

        $(document).on("click", "#applyButton", function () {
          const selectedOptions = [];
          dropdownMenu.find("input[type='checkbox']:checked").each(function () {
            selectedOptions.push($(this).val());
          });

          $.ajax({
            url: "http://localhost:8080/policy/applySelectedOptions",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ selectedOptions: selectedOptions }),
            success: function (response) {
              if (response.status === 200) {
                alert("Options applied successfully");
                dropdownMenu.addClass("hidden");
              } else {
                alert("Failed to apply options");
              }
            },
            error: function () {
              alert("Error applying options");
            },
          });
        });
      });
    </script>
  </body>
</html>
